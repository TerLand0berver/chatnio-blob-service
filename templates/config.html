<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blob Service 配置</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .config-section {
            margin-bottom: 2rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <h1 class="mb-4">Blob Service 配置</h1>
        
        <form id="configForm">
            <div class="config-section">
                <h3>基础配置</h3>
                <div class="form-group">
                    <label for="pdf_max_images">PDF最大图片数</label>
                    <input type="number" class="form-control" id="pdf_max_images" name="pdf_max_images">
                </div>
                <div class="form-group">
                    <label for="max_file_size">最大文件大小(MiB)</label>
                    <input type="number" class="form-control" id="max_file_size" name="max_file_size">
                </div>
                <div class="form-group">
                    <label for="cors_allow_origins">CORS允许域名</label>
                    <input type="text" class="form-control" id="cors_allow_origins" name="cors_allow_origins">
                </div>
            </div>

            <div class="config-section">
                <h3>存储配置</h3>
                <div class="form-group">
                    <label for="storage_type">存储类型</label>
                    <select class="form-control" id="storage_type" name="storage_type">
                        <option value="base64">Base64</option>
                        <option value="local">本地存储</option>
                        <option value="s3">S3兼容存储</option>
                        <option value="tg">Telegram CDN</option>
                        <option value="alist">Alist存储</option>
                    </select>
                </div>

                <!-- 本地存储配置 -->
                <div id="local_config" class="storage-config" style="display: none;">
                    <div class="form-group">
                        <label for="local_storage_domain">存储域名</label>
                        <input type="text" class="form-control" id="local_storage_domain" name="local_storage_domain">
                    </div>
                </div>

                <!-- S3配置 -->
                <div id="s3_config" class="storage-config" style="display: none;">
                    <div class="form-group">
                        <label for="s3_access_key">Access Key</label>
                        <input type="text" class="form-control" id="s3_access_key" name="s3_access_key">
                    </div>
                    <div class="form-group">
                        <label for="s3_secret_key">Secret Key</label>
                        <input type="password" class="form-control" id="s3_secret_key" name="s3_secret_key">
                    </div>
                    <div class="form-group">
                        <label for="s3_bucket">Bucket</label>
                        <input type="text" class="form-control" id="s3_bucket" name="s3_bucket">
                    </div>
                    <div class="form-group">
                        <label for="s3_region">Region</label>
                        <input type="text" class="form-control" id="s3_region" name="s3_region">
                    </div>
                    <div class="form-group">
                        <label for="s3_domain">Domain</label>
                        <input type="text" class="form-control" id="s3_domain" name="s3_domain">
                    </div>
                </div>

                <!-- Telegram配置 -->
                <div id="tg_config" class="storage-config" style="display: none;">
                    <div class="form-group">
                        <label for="tg_endpoint">TG-STATE Endpoint</label>
                        <input type="text" class="form-control" id="tg_endpoint" name="tg_endpoint">
                    </div>
                    <div class="form-group">
                        <label for="tg_password">Password (可选)</label>
                        <input type="password" class="form-control" id="tg_password" name="tg_password">
                    </div>
                </div>

                <!-- Alist配置 -->
                <div id="alist_config" class="storage-config" style="display: none;">
                    <div class="form-group">
                        <label for="alist_endpoint">Alist服务地址</label>
                        <input type="text" class="form-control" id="alist_endpoint" name="alist_endpoint" placeholder="http://your-alist-server:5244">
                    </div>
                    <div class="form-group">
                        <label for="alist_username">用户名</label>
                        <input type="text" class="form-control" id="alist_username" name="alist_username">
                    </div>
                    <div class="form-group">
                        <label for="alist_password">密码</label>
                        <input type="password" class="form-control" id="alist_password" name="alist_password">
                    </div>
                    <div class="form-group">
                        <label for="alist_path">存储路径</label>
                        <input type="text" class="form-control" id="alist_path" name="alist_path" placeholder="/blob">
                    </div>
                </div>
            </div>

            <div class="config-section">
                <h3>API响应格式</h3>
                <div class="form-group">
                    <label for="status_field">状态字段名</label>
                    <input type="text" class="form-control" id="status_field" name="status_field" placeholder="status">
                </div>
                <div class="form-group">
                    <label for="type_field">类型字段名</label>
                    <input type="text" class="form-control" id="type_field" name="type_field" placeholder="type">
                </div>
                <div class="form-group">
                    <label for="content_field">内容字段名</label>
                    <input type="text" class="form-control" id="content_field" name="content_field" placeholder="content">
                </div>
                <div class="form-group">
                    <label for="error_field">错误字段名</label>
                    <input type="text" class="form-control" id="error_field" name="error_field" placeholder="error">
                </div>
                <div class="form-group">
                    <label for="success_value">成功状态值</label>
                    <input type="text" class="form-control" id="success_value" name="success_value" placeholder="true">
                </div>
                <div class="form-group">
                    <label for="error_value">错误状态值</label>
                    <input type="text" class="form-control" id="error_value" name="error_value" placeholder="false">
                </div>
                <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" id="include_type" name="include_type" checked>
                    <label class="form-check-label" for="include_type">包含类型字段</label>
                </div>
                <div class="form-check mb-3">
                    <input type="checkbox" class="form-check-input" id="wrap_content" name="wrap_content">
                    <label class="form-check-label" for="wrap_content">包装内容字段</label>
                </div>
                <div id="content_wrapper_config" style="display: none;">
                    <div class="form-group">
                        <label>内容包装格式模板</label>
                        <select class="form-control mb-3" id="content_wrapper_template">
                            <option value="">自定义格式</option>
                            <option value="link">返回链接 (save-all)</option>
                            <option value="content">返回内容</option>
                            <option value="markdown">Markdown 原始格式</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>内容包装格式 (JSON)</label>
                        <textarea class="form-control" id="content_wrapper" name="content_wrapper" rows="4" placeholder='{"text": "${content}", "extra": "additional info"}'></textarea>
                        <small class="form-text text-muted">使用 ${content} 作为内容占位符</small>
                    </div>
                </div>
            </div>

            <div class="config-section">
                <h3>功能配置</h3>
                <div class="form-group">
                    <label for="azure_speech_key">Azure Speech Key</label>
                    <input type="password" class="form-control" id="azure_speech_key" name="azure_speech_key">
                </div>
                <div class="form-group">
                    <label for="azure_speech_region">Azure Speech Region</label>
                    <input type="text" class="form-control" id="azure_speech_region" name="azure_speech_region">
                </div>
                <div class="form-group">
                    <label for="ocr_endpoint">OCR Endpoint</label>
                    <input type="text" class="form-control" id="ocr_endpoint" name="ocr_endpoint">
                </div>
            </div>

            <button type="submit" class="btn btn-primary">保存配置</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 显示/隐藏相应的存储配置
        document.getElementById('storage_type').addEventListener('change', function() {
            document.querySelectorAll('.storage-config').forEach(el => el.style.display = 'none');
            const selectedConfig = document.getElementById(this.value + '_config');
            if (selectedConfig) {
                selectedConfig.style.display = 'block';
            }
        });

        // 显示/隐藏内容包装配置
        document.getElementById('wrap_content').addEventListener('change', function() {
            const wrapperConfig = document.getElementById('content_wrapper_config');
            wrapperConfig.style.display = this.checked ? 'block' : 'none';
        });

        // 处理内容包装格式模板选择
        document.getElementById('content_wrapper_template').addEventListener('change', function() {
            const contentWrapper = document.getElementById('content_wrapper');
            switch(this.value) {
                case 'link':
                    contentWrapper.value = '{"url": "${content}", "type": "link"}';
                    break;
                case 'content':
                    contentWrapper.value = '{"data": "${content}", "type": "content"}';
                    break;
                case 'markdown':
                    contentWrapper.value = '{"markdown": "${content}", "raw": true}';
                    break;
            }
        });

        // 表单提交处理
        document.getElementById('configForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert('配置已保存');
                } else {
                    alert('保存失败：' + (await response.text()));
                }
            } catch (error) {
                alert('保存失败：' + error.message);
            }
        });

        // 加载当前配置
        async function loadCurrentConfig() {
            try {
                const response = await fetch('/api/config');
                if (response.ok) {
                    const config = await response.json();
                    Object.entries(config).forEach(([key, value]) => {
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = value;
                        }
                    });
                    // 触发存储类型变更事件以显示相应配置
                    document.getElementById('storage_type').dispatchEvent(new Event('change'));
                    document.getElementById('wrap_content').dispatchEvent(new Event('change'));
                }
            } catch (error) {
                console.error('加载配置失败：', error);
            }
        }

        // 页面加载时获取当前配置
        loadCurrentConfig();
    </script>
</body>
</html>
